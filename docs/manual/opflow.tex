\chapter{Optimal power flow (OPFLOW)}\label{chap:opflow}

OPFLOW solves the full AC optimal power flow problem and provides various flexible features that can be toggled via run-time options. It has interfaces to different optimization solvers and includes different representations of the underlying equations (power-balance-polar and power-balance-cartesian) that can be used. By selecting the appropriate solver, OPFLOW can be executed on CPU (in serial or parallel) or on GPUs.

\section{Formulation}
Optimal power flow is a general nonlinear programming problem with the following form
\begin{align}
\text{min. }& f(x) \\
&\text{s.t.} \nonumber \\
& g(x) = 0 \\
& h(x) \le 0 \\
& x^{\text{min}} \le x \le x^{\text{max}}
\end{align}
Here, $x$ are the decision variables with lower and upper bounds $x^{\text{min}}$ and $x^{\text{max}}$, respectively, $f(x)$ is the objective function, $g(x)$ and $h(x)$ are the equality and inequality constraints, respectively. In the following sections we describe what constitutes these different terms as used by OPFLOW.

\subsection{Variables and bounds} \label{subsec:opflow_var}

The different variables used in \opflow formulation are described in Table \ref{tab:opflow_vars}.

\begin{table}[!htbp]
\caption{Optimal power flow (OPFLOW) variables}
\small
  \begin{tabular}{|p{0.25\textwidth}|p{0.1\textwidth}|p{0.2\textwidth}|p{0,45\textwidth}|}
   \hline
    \textbf{Variable} & \textbf{Symbol} & \textbf{Bounds} & \textbf{Notes} \\
    \hline
    Generator real power dispatch & $\pgj$ & $\pminj \le \pgj \le \pmaxj$ & ~\\
    \hline
    Generator reactive power dispatch & $\qgj$ & $\qminj \le \qgj \le \qmaxj$ & ~ \\
    \hline
    Generator real power upward deviation & $\Deltapupj$ & $0 \le \Deltapupj \le p^{\text{r}}_j$ & \begin{itemize} \item Only used when \option{\opflowgensetpoint} or \option{\opflowuseagc} option is active \item $\Deltapupj$ is the upward deviation from real power generation setpoint $\psetj$. ($\pgj \ge \psetj$) \end{itemize} \\
    \hline
    Generator real power downward deviation & $\Deltapdownj$ & $0 \le \Deltapdownj \le p^{\text{r}}_j$ & \begin{itemize} \item Only used when \option{\opflowgensetpoint} or \option{\opflowuseagc} option is active \item $\Deltapdownj$ is the downward deviation from real power generation setpoint $\psetj$. ($\pgj \le \psetj$)\end{itemize} \\
    \hline
    Generator real power set-point & $\pgjset$ & $\pminj \le \pgjset \le \pmaxj$ & \begin{itemize} \item Only used when \option{\opflowgensetpoint} or \option{\opflowuseagc} option is active. \end{itemize} \\
    \hline
    System power excess/deficit & $\Delta{P}$ & Unbounded & Only used when \option{\opflowuseagc} is active \\
    \hline
    Bus voltage angle & $\thetai$ & -$\pi \le \thetai \le \pi$ & 
    \begin{itemize} 
    	\item Used with power balance polar model (\option{\opflowmodel~\pbcar}) 
	\item $\thetai$ is unbounded, except reference bus angle $\thetarefi$ which is fixed to 0 
    \end{itemize} \\
    \hline
    Bus voltage magnitude & $\vi$ & $\vmini \le \vi \le \vmaxi$ & \begin{itemize} \item Used with power balance polar model (\option{\opflowmodel~\pbpol})\item $\vmini = \vmaxi = \vseti$ if fixed generator set point voltage option is active (\option{\opflowgensetpoint}) \end{itemize} \\
    \hline
    Bus voltage real part & $\vreali$ & $-\vmaxi \le \vreali \le \vmaxi$ & Used with power balance cartesian model (\option{\opflowmodel~ \pbcar})\\
    \hline
    Bus voltage imaginary part & $\vimagi$ & $-\vmaxi \le \vimagi \le \vmaxi$ & Used with power balance cartesian model (\option{\opflowmodel~\pbcar})\\
    \hline
    Bus real power mismatch & $\pmisi$ & Unbounded & Used when power mismatch variable option is active (\option{\opflowincludepowerimbalance 1}) \\
    \hline
    Bus reactive power mismatch & $\qmisi$ & Unbounded & Used when power mismatch variable option is active (\option{\opflowincludepowerimbalance 1}) \\
    \hline
    Real power load loss & $\Deltaplj$ & $0 \le \Deltaplj \le \plj $ & Used when load loss variable option is active (\option{\opflowincludeloadloss 1}) \\
    \hline
    Reactive power load loss & $\Deltaqlj$ & $0 \le \Deltaqlj \le \qlj$ & Used when load loss variable option is active (\option{\opflowincludeloadloss 1}) \\
    \hline
  %  Bus reactive power mismatch & $q^{mis}_i$ & Unbounded & Used when power mismatch variable option is active (\text{-opflow_include_powerimbalance_variables 1})
  %  \hline
  \end{tabular}
  \label{tab:opflow_vars}
\end{table}
Power imbalance variables are non-physical (slack) variables that measure the violation of power balance at buses. Having these variables (may) help in making the optimization problem easier to solve since they always ensure feasibility of the bus power balance constraints.

\subsection{Objective Function}\label{sec:opflow_obj}

The objective function for OPFLOW is given in (\ref{eq:opflow_obj})
\begin{equation}
\text{min.} ~ C(p^{\text{g}}) + C(\Delta p^{\text{gu}},\Delta p^{\text{gd}}) + C(\Delta p^{\text{l}},\Delta q^{\text{l}}) + C(\Delta p,\Delta q)
\label{eq:opflow_obj}
\end{equation}
 
\subsubsection{Total generation cost $C(p^{\text{g}})$}
Needs \opflowoption{\opflowobjective}{\mingencost}
\begin{equation}
C(p^{\text{g}}) = \sum_{\jinJgen} \costgj(\pgj)
\label{eq:opf_obj_mingencost}
\end{equation}
Here, $\costgj$ is a quadratic function of the form $\costgj = \agj{\pgj}^2 + \bgj\pgj + \cgj$.

\subsubsection{Total generation setpoint deviation $C(\Delta p^{\text{gu}},\Delta p^{\text{gd}})$}
Needs \opflowoption{\opflowobjective}{\mingensetpointdeviation} option
\begin{equation}
C(\Delta p^{\text{gu}},\Delta p^{\text{gd}}) = \sum_{\jinJgen} ({\Deltapupj}^2 + {\Deltapdownj}^2)
\label{eq:opf_obj_mingensetpointdev}
\end{equation}

\subsubsection{Load loss $C(\Delta p^{\text{l}},\Delta q^{\text{l}})$}
This term gets added to the objective when  \option{\opflowincludeloadloss} option is active. 
\begin{equation}
C(\Delta p^{\text{l}},\Delta q^{\text{l}}) =  \sum_{\jinJload} \sigmalj({\Deltaplj}^2 + {\Deltaqlj}^2)
\label{eq:opf_obj_minloadloss}
\end{equation}
The load loss penalty $\sigmalj$ can be set via the option \option{-opflow\_loadloss\_penalty}. The default is \$100/MW for all loads.

\subsubsection{Power imbalance $C(\Delta p,\Delta q)$}
This term gets added to the objective when  \option{-opflow\_include_powerimbalance_variables} option is active. 
\begin{equation}
C(\Delta p,\Delta q) =  \sum_{i \in J^{bus}} \sigmai({\Delta p_i}^2 + {\Delta q_i}^2)
\label{eq:opf_obj_minpowerimbalance}
\end{equation}
The power imbalance cost $\sigmai$ can be set via the option \option{-opflow\_powerimbalance\_penalty}. The default is \$1000/MW for all buses.

\subsection{Equality constraints}\label{sec:opflow_eq}

\subsubsection{Nodal power balance}
\begin{align}
\sum_{\substack{\jinJgen \\ A^{\text{g}}_{ij} \neq 0}} \pgj &=   \pshi + \sum_{\substack{\jinJload \\ A^{\text{l}}_{ij} \neq 0}} \plj + \sum_{\substack{\jinJbr \\ A^{\text{br}}_{oi} \neq 0}} \pbrjod + \sum_{\substack{\jinJbr \\ A^{\text{br}}_{id} \neq 0}} \pbrjdo \\
\sum_{\substack{\jinJgen \\ A^{\text{g}}_{ij} \neq 0}} \qgj &=  \qshi + \sum_{\substack{\jinJload \\ A^{\text{l}}_{ij} \neq 0}} \qlj +
\sum_{\substack{\jinJbr \\ A^{\text{br}}_{oi} \neq 0}} \qbrjod + \sum_{\substack{\jinJbr \\ A^{\text{br}}_{id} \neq 0}} \qbrjdo \\
\end{align}
where, the real and reactive power shunt consumption is given by (\ref{eq:opflow_sh_p}) and (\ref{eq:opflow_sh_q})


The real and reactive power flow $\pbrjod$, $\qbrjod$ for line $j$ from the origin bus $o$ to bus $d$ is given by (\ref{eq:opflow_br_podflow}) -- 
 (\ref{eq:opflow_br_qodflow})
and from destination bus $d$ to origin bus $o$ is given by (\ref{eq:opflow_br_pdoflow}) -- 
 (\ref{eq:opflow_br_qdoflow})

\subsubsection{Generator real power output}

When using \option{\opflowgensetpoint}, three extra variables $\pgjset$, $\Deltapupj$ and $\Deltapdownj$ are added for each generator. The generator real power output $\pgj$ is related to the power deviations $\Deltapupj$ and $\Deltapdownj$ by the following relations
\begin{align}
  \pgjset + \Deltapupj - \Deltapdownj - \pgj = 0 \\
  \pgjset - p^{\text{g*}}_j = 0
\end{align}
Here, $p^{\text{g*}}_j$ is the set-point for the generator real power output, which can be thought of as an operator set or contractual agreement set-point.

\subsection{Inequality constraints}

\subsubsection{MVA flow on branches}
MVA flow limits at origin and destination buses for each line.
\begin{align}
  {\pbrjod}^2 + {\qbrjod}^2 \le {\srateAj}^2,~~\jinJbr\\
  {\pbrjdo}^2 + {\qbrjdo}^2 \le {\srateAj}^2,~~\jinJbr
\end{align}
To reduce the size of inequality constraints, only lines that are in service and having MVA A rating $\srateAj$ less than 10000 MVA are considered.

\subsubsection{Generator real power output}
When using \option{\opflowgensetpoint}, the following constraints are added to the formulation
\begin{align}
  0 \le \pgjset + \Deltapupj \le \pmaxj \\
\pminj \le \pgjset - \Deltapdownj \\
0 \le \Deltapupj(\Deltapupj - \Deltapdownj) \\
0 \le \Deltapdownj(\Deltapdownj - \Deltapupj)
\end{align}

\subsubsection{Automatic generation control (AGC)}
With \option{\opflowuseagc}, two additional constraints are added for each participating generator to enforce the proportional generator redispatch participation as done in automatic generation control (AGC). These two equations are 
\begin{equation}
\begin{aligned}
  \left(\alpha^{\text{g}}_j\Delta{P} - (\Deltapupj - \Deltapdownj)\right)\left(\pgj - \pmaxj\right) \ge 0 \\
  \left((\Deltapupj - \Deltapdownj) - \alpha_j\Delta{P}\right)\left(\pminj - \pgj\right) \ge 0
\end{aligned}
\label{eq:opflow_agc}
\end{equation}
Eq. \ref{eq:opflow_agc} enforces the generator set-point deviation to be equal to the generation participation when the generator has head-room available $\pminj \le \pgj \le \pmaxj$. Here, $\alpha^{\text{g}}_j$ is the generator participation factor which is the proportion of the power deficit/excess $\Delta{P}$ that the generator provides.

\subsubsection{Generator bus voltage control}
When the option \opflowoption{\opflowgenbusvoltage \fixedwithinqbounds} is used, the generator bus voltage is fixed when the total reactive power generation available at the bus is within bounds. When it reaches its bounds, the voltage varies with the generator reactive power fixed at its bound. To implement this behavior, two inequality constraints are added for each generator bus
\begin{equation}
\begin{aligned}
(v^{\text{set}}_i - \vi)(q_i - q^{\text{max}_i}) \ge 0 \\
(\vi - v^{\text{set}}_i)(q^{\text{min}_i} - q_i) \ge 0
\end{aligned}
\label{eq:opflow_genbusvoltage}
\end{equation}
Here, $q_i$, $q^{\text{max}_i}$, and $q^{\text{min}_i}$ are the generated, maximum, and minimum reactive power at the bus, respectively.

\begin{comment}
\subssubection{Voltage magnitude for cartesian coordinates}
When using cartesian coordinates for voltages, inequality constraints (\ref{eq:opflow_ineq_vmag}) need to introduced to constraining the voltage magnitude within its bounds
\begin{equation}
  {\vmini}^2 \le {\vreali}^2 + {\vimagi}^2 \le {\vmaxi}^2,~~\iinJbus
\label{eq:opflow_ineq_vmag}
\end{equation}
\end{comment}

\section{Models}\label{sec:opflow_model}

\begin{table}[!h]
  \caption{OPFLOW models}
  \small
  \begin{tabular}{|p{0.25\textwidth}|p{0.4\textwidth}|p{0.2\textwidth}|p{0.15\textwidth}|}
    \hline
    \textbf{Model type} & \textbf{OPFLOW option} & \textbf{Compatible solvers} & \textbf{CPU-GPU}\\
    \hline
    Power balance with polar coordinates & \opflowoption{\opflowmodel}{\pbpol} & IPOPT & CPU\\
    \hline
    Power balance with cartesian coordinates & \opflowoption{\opflowmodel}{\pbcar} & IPOPT, TAO & CPU\\
    \hline
    Power balance with polar coordinates used with HIOP & \opflowoption{\opflowmodel}{\pbpolhiop} & \hiop & CPU\\
    \hline
    Power balance with polar coordinates used with HIOP on GPU & \opflowoption{\opflowmodel}{\pbpolrajahiop} & IPOPT, TAO & GPU\\
    \hline
  \end{tabular}
  \label{tab:opflow_models}
\end{table}

\subsection{Power balance polar}

\subsubsection{Shunt power}
\begin{align}
&\pshi = \gshi{\vi}^2 \label{eq:opflow_sh_p} \\
&\qshi = -\bshi{\vi}^2 \label{eq:opflow_sh_q}
\end{align}

\subsubsection{Branch flows}
The real and reactive power flow $\pbrjod$, $\qbrjod$  from bus $o$ to bus $d$ on line $j$ is given by (\ref{eq:opflow_br_podflow}) -- 
 (\ref{eq:opflow_br_qodflow})


\begin{align}
\pbrjod &= g_{oo}{v^2_o} + v_ov_d(g_{od}\cos(\theta_o - \theta_d) + b_{od}\sin(\theta_o - \theta_d)) \label{eq:opflow_br_podflow}\\
\qbrjod &= -b_{oo}{v^2_o} + v_ov_d(-b_{od}\cos(\theta_o - \theta_d) + g_{od}\sin(\theta_o - \theta_d)) \label{eq:opflow_br_qodflow}
\end{align}

and from bus $i$ to bus $d$ is given by (\ref{eq:opflow_br_pdoflow}) -- (\ref{eq:opflow_br_qdoflow})

\begin{align}
\pbrjdo &= g_{dd}{v^2_d} + v_dv_o(g_{do}\cos(\theta_d - \theta_o) + b_{do}\sin(\theta_d - \theta_o))  \label{eq:opflow_br_pdoflow} \\
\qbrjdo &= -b_{dd}{v^2_d} + v_dv_o(-b_{do}\cos(\theta_d - \theta_o) + g_{do}\sin(\theta_d - \theta_o)) \label{eq:opflow_br_qdoflow}
\end{align}

\begin{comment}
\subsection{Power balance cartesian}
\end{comment}

\subsection{Power balance with HiOp}
Power balance formulation with polar coordinates used with \hiop \cite{hiop-manual} library. This model runs on CPU only, though the \hiop solver can run on GPU.

\subsection{Power balance with HiOp,RAJA,and Umpire}
Power balance formulation with polar coordinates used with \hiop and \raja. This model uses \raja~\cite{beckingsale2019raja} and Umpire \cite{beckingsale2019umpire} libraries to run \opflow calculations (objective, constraints, etc.) on the GPU. 

\section{Solvers}\label{sec:opflow_solvers}
\opflow can be used with a few different solvers. All the three solvers solve the optimization problem via a nonlinear interior-point algorithm.
\begin{enumerate}
  \item \ipopt~is a popular open-source package for solving nonlinear optimization problems. It is the most robust of the solvers implemented for solving \opflow. However, it can be run only on a single process and does not have GPU support. Option: \\
  \opflowoption{-opflow\_solver IPOPT}
  \item The Toolkit for Applied Optimization (\tao) is a toolkit available through \petsc for solving optimization problems. TAO includes a interior-point algorithm that is used by OPFLOW. The TAO algorithm is fully parallel, but is less robust compared to IPOPT. Currently, the TAO solver can only used with the power balance cartesian model. Option:\\ \opflowoption{-opflow\_solver TAO} \opflowoption{POWER\_BALANCE\_CARTESIAN}
  \item \hiop~ is a high-performance optimization library that implements an interior-point algorithm for solving nonlinear optimization problems. The library supports execution both on the CPU and the GPU. Options: \\ CPU: \opflowoption{-opflow\_solver HIOP} \opflowoption{-opflow\_model POWER\_BALANCE\_HIOP} \\ GPU: \opflowoption{-opflow\_solver HIOP} \opflowoption{-opflow\_model PBPOLRAJAHIOP}
\end{enumerate}

\begin{table}
  \centering
  \caption{OPFLOW Model-solver compatibility}
  \begin{tabular}{|c|c|c|c|}
    \hline
    Model & \ipopt & \hiop & \tao \\ \hline
    POWER\_BALANCE\_POLAR & \checkmark & & \\ \hline
    POWER\_BALANCE\_CARTESIAN & \checkmark &  & \checkmark \\ \hline
    POWER\_BALANCE\_HIOP & & \checkmark & \\ \hline
    PBPOLRAJAHIOP & & \checkmark & \\ \hline
  \end{tabular}
\label{tab:opflow_model_solver_compatibility}
\end{table}

\section{Input and Output}
The current \exago version only supports reading network file in \matpower format and can (optionally) write the output back in \matpower data file format.

\section{Usage}
\begin{lstlisting}
  ./opflow -netfile <netfilename>  <opflowoptions>
\end{lstlisting}

\section{Options}
See table \ref{tab:opflow_options}
\begin{table}[!htbp]
  \caption{OPFLOW options}
  \small
  \begin{tabular}{|p{0.4\textwidth}|p{0.3\textwidth}|p{0.3\textwidth}|}
    \hline
    \textbf{Option} & \textbf{Meaning} & \textbf{Values (Default value)} \\ \hline
    -netfile & Network file name & string (\href{https://gitlab.pnnl.gov/exasgd/frameworks/exago/-/blob/master/datafiles/case9/case9mod.m}{case9mod.m}) \\ \hline
    -print\_output & Print output to screen & 0 or 1 (0) \\ \hline
    -save\_output & Save output to file & 0 or 1 (0) \\ \hline
    -opflow\_model & Representation of network balance equations and bus voltages & See Table \ref{sec:opflow_model} (POWER\_BALANCE\_POLAR) \\ \hline
    -opflow\_solver & Optimization solver & See section \ref{sec:opflow_solvers} \\ \hline
    -opflow\_initialization & Type of initialization & See Table \ref{tab:opflow_initializations} (MIDPOINT) \\ \hline
    -opflow\_has\_gensetpoint & Uses generation set point and activates ramping variables & 0 or 1 (0) \\ \hline
    -opflow\_use\_agc & Uses AGC formulation in OPF & 0 or 1 (0) \\
    -opflow\_objective & type of objective function & See table \ref{sec:opflow_objtypes} (MIN\_GEN\_COST) \\ \hline
    -opflow\_genbusvoltage & Type of generator bus voltage control & See Table \ref{tab:opflow_genbusvoltage} (FIXED\_WITHIN\_QBOUNDS) \\ \hline
    -opflow\_ignore\_lineflow\_constraints & Ignore line flow constraints & 0 or 1 (0) \\ \hline
    -opflow\_include\_loadloss\_variables & Include load loss & 0 or 1 (0) \\ \hline
    -opflow\_include\_powerimbalance\_variables & Include power imbalance & 0 or 1 (0) \\ \hline
    -opflow\_loadloss\_penality & \$ penalty for load loss & real (1000) \\ \hline
    -opflow\_powerimbalance\_penalty & \$ penalty for power imbalance & real (10000) \\ \hline
    -opflow\_tolerance & Optimization solver tolerance & real (1e-6) \\ \hline 
  \end{tabular}
  \label{tab:opflow_options}
\end{table}

\begin{table}[!htbp]
  \centering
  \caption{OPFLOW initializations}
  \begin{tabular}{|c|c|}
    \hline
    \textbf{Initialization type} & \textbf{Meaning} \\ \hline
    MIDPOINT & Use mid-point of bounds \\ \hline
    FROMFILE & Use values from network file \\ \hline
    ACPF & Run AC power flow for initialization \\ \hline
    FLATSTART & Flat-start \\ \hline
  \end{tabular}
\label{tab:opflow_initializations}
\end{table}

\begin{table}[!htbp]
  \centering
  \caption{OPFLOW generator bus voltage control modes}
  \begin{tabular}{|c|c|}
    \hline
    \textbf{Voltage control type} & \textbf{Meaning} \\ \hline
    FIXED\_AT\_SETPOINT & Fixed at given set-point. Reactive power limits are ignored \\ \hline
    FIXED\_WITHIN\_QBOUNDS & Fixed within reactive power bounds \\ \hline
    VARIABLE\_WITHIN\_BOUNDS & Variable within voltage bounds \\ \hline
  \end{tabular}
\label{tab:opflow_genbusvoltage}
\end{table}

\begin{table}[!htbp]
  \centering
  \caption{OPFLOW objective function types}
  \begin{tabular}{|c|c|}
    \hline
    \textbf{Objective function} & \textbf{Meaning} \\ \hline
    MIN\_GEN\_COST & Minimize generation cost \\ \hline
    MIN\_GENSETPOINT\_DEVIATION & Minimize deviation (ramp up-down) from generataor set-point \\ \hline
    NO\_OBJ & No objecive function \\ \hline
  \end{tabular}
\label{tab:opflow_objtypes}
\end{table}


\section{Examples}
\todo
